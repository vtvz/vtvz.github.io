<!doctype html>
<html lang="en">
    <!--Built at : 2024-08-20 23:03:19-->
    <head>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Покорение UTM меток | Vitaly Zaslavsky</title>

        <link rel="shortcut icon" href="/favicon.png" type="image/png">

        <link rel="stylesheet" href="/assets/css/preloader.8ed26a51.css" />
        <link rel="stylesheet" href="/assets/css/bootstrap.06019c8f.css" />
        <link rel="stylesheet" href="/assets/css/main.8cc238a7.css" />

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:300,400,500,600,700,800|Roboto:300,400,500,600,700,800&display=swap&subset=cyrillic,cyrillic-ext" rel="stylesheet" crossorigin="anonymous">

        <link rel="alternate" type="application/rss+xml" title="Vitaly Zaslavsky – DevOps Engineer, who loves his job" href="https://vtvz.me/feed.xml">
        <link rel="alternate" type="application/rss+xml" title="My Achievements | Vitaly Zaslavsky" href="https://vtvz.me/feed/achievements.xml">
        <link rel="alternate" type="application/rss+xml" title="My Bookmarks | Vitaly Zaslavsky" href="https://vtvz.me/feed/bookmarks.xml">
        <link rel="alternate" type="application/rss+xml" title="My Notes | Vitaly Zaslavsky" href="https://vtvz.me/feed/notes.xml">

        <meta name="theme-color" content="#232323">

        <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Покорение UTM меток" />
<meta name="author" content="Vitaly Zaslavsky" />
<meta property="og:locale" content="ru" />
<meta name="description" content="Элегантный способ укоротить UTM метки" />
<meta property="og:description" content="Элегантный способ укоротить UTM метки" />
<link rel="canonical" href="https://vtvz.me/blog/conquering-the-utm-parameters/" />
<meta property="og:url" content="https://vtvz.me/blog/conquering-the-utm-parameters/" />
<meta property="og:site_name" content="Vitaly Zaslavsky – DevOps Engineer, who loves his job" />
<meta property="og:image" content="https://vtvz.me/blog/conquering-the-utm-parameters/cover.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-13T00:00:00+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://vtvz.me/blog/conquering-the-utm-parameters/cover.jpg" />
<meta property="twitter:title" content="Покорение UTM меток" />
<meta name="twitter:site" content="@vtvz_me" />
<meta name="twitter:creator" content="@vtvz_me" />
<meta name="google-site-verification" content="40uemu1o4UDeTOeeLKqJVoaPU4CVUjlGI5D9AI1EkNE" />
<meta name="yandex-verification" content="fa3eb4fcd2ebc4ad" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Vitaly Zaslavsky"},"dateModified":"2020-05-13T00:00:00+03:00","datePublished":"2020-05-13T00:00:00+03:00","description":"Элегантный способ укоротить UTM метки","headline":"Покорение UTM меток","image":"https://vtvz.me/blog/conquering-the-utm-parameters/cover.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://vtvz.me/blog/conquering-the-utm-parameters/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://vtvz.me/assets/images/logo-black.png"},"name":"Vitaly Zaslavsky"},"url":"https://vtvz.me/blog/conquering-the-utm-parameters/"}</script>
<!-- End Jekyll SEO tag -->


        <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/webfonts/fa-regular-400.woff2" as="font" />
        <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/webfonts/fa-brands-400.woff2" as="font" />
        <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/webfonts/fa-solid-900.woff2" as="font" />
    </head>

    <body class="full-layout">
        <div id="preloader">
    <div class="preloader__spinner"></div>
</div>

<div id="bg"></div>

<div class="body-wrapper">
    <nav class="navbar navbar-default" role="navigation">
    <div class="navbar-header">
        <a class="btn responsive-menu" data-toggle="collapse" data-target=".navbar-collapse"><i></i></a>
        <div class="navbar-brand text-center">
            <a href="/">
                <svg width="64px" height="64px" viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="logo" id="main-logo">
    <metadata id="metadata7">image/svg+xml</metadata>
    <g>
        <path id="left-eye" fill="#000" class="logo__piece logo__eye" d="M 292.185,573.771 L 387.59772,628.52957 393.82031,697.80751 343.21008,675.40626 Z"></path>
        <path id="right-eye" fill="#000" class="logo__piece logo__eye" d="M 638.57461,625.62571 L 632.35207,698.22232 683.79196,675.82107 734.40218,572.94128 Z"></path>
        <path id="face" fill="#000" class="logo__piece" d="m74.013423,308.628134l119.0939,184.214156l-75.09366,163.094047c21.287511,6.059785 47.827858,16.218479 68.574554,25.196346c32.625314,14.118218 58.700392,28.772931 86.892875,46.37732c-46.488875,-12.947705 -100.710811,-26.440733 -132.000626,-21.120109c68.761424,31.900881 145.390462,69.291367 314.038649,239.663892l39.72301,-0.078985l-139.920649,-592.537851l-248.985112,-341.177843l-32.32294,296.369028zm598.989449,41.582319l-143.147377,595.762488l42.148039,0.083631c76.185978,-75.014954 141.727968,-154.245855 310.147052,-238.270502c-31.289861,-5.320623 -85.511797,8.172404 -132.000672,21.120109c28.19253,-17.604389 54.267561,-32.259102 86.892875,-46.37732c20.746696,-8.977867 47.287089,-19.136561 68.574554,-25.196346l-75.09366,-163.094047l119.0939,-184.214156l-29.161677,-295.491224l-247.453033,335.677365zm293.628151,-36.667029l-116.747299,181.280788l80.960443,176.000772c-23.816754,1.721318 -45.965296,6.720007 -66.88037,17.600068c32.696772,-1.504713 59.86756,-0.242066 89.467093,9.093371c-172.472461,59.218813 -314.438871,186.268605 -439.708757,326.481593c-156.142938,-181.558909 -350.942912,-320.860315 -452.028763,-324.650392c29.59958,-9.33553 65.277111,-13.824765 97.973837,-12.320052c-20.915027,-10.880061 -43.063615,-15.87875 -66.88037,-17.600068l80.960443,-176.000772l-116.747299,-181.280788l45.210942,-312.147931l257.803893,254.290031l153.707316,-26.400079l154.306255,24.225247l256.161049,-249.03255l42.441584,310.460762z"></path>
    </g>
</svg>

            </a>
            <div class="navbar-subscribe navbar-subscribe--hidden">
                <a class="navbar-subscribe__link" href="#subscribe">
                    <span class="navbar-subscribe__content navbar-subscribe__content--wide"></span>
                    <span class="navbar-subscribe__content navbar-subscribe__content--narrow"></span>
                </a>
            </div>
        </div>
    </div>
    <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
            <li class="">
                <a href="/#main" class="hint--right" data-hint="Main" data-section-id="main">
                    <i class="fa-solid fa-home fa-fw"></i><span>Main</span>
                </a>
            </li>
            <li>
                <a href="/#cv" class="hint--right" data-hint="CV" data-section-id="cv">
                    <i class="fa-regular fa-address-card fa-fw"></i><span>CV</span>
                </a>
            </li>
            
            <li>
            
                <a href="/collections/" class="hint--right" data-hint="Collections">
                    <i class="fa-solid fa-star fa-fw"></i><span>Collections</span>
                </a>
            </li>
            <li class="current">
                <a href="/blog/" class="hint--right" data-hint="Blog">
                    <i class="fa-solid fa-pencil-alt fa-fw"></i><span>Blog</span>
                </a>
            </li>
        </ul>
    </div>
</nav>

    <div class="container inner blog">
    <div class="row">
        <div class="col-md-8 col-sm-12 content">
            <div>
    <div class="post box" itemscope itemtype="http://schema.org/BlogPosting">
        <div class="post-main-image" style="background-image: url(/blog/conquering-the-utm-parameters/cover.jpg)">
    <a href="/blog/conquering-the-utm-parameters/">
        <img src="/blog/conquering-the-utm-parameters/cover.jpg" alt="Покорение UTM меток">
    </a>
    
    <a class="post-main-image__src" href="https://www.accelerate-agency.com/4-clicks-2-measurement-analytics-automation-superweek" target="_blank" rel="noopener noreferrer">Image source</a>
    
</div>


        <div class="post-meta">
    <span class="post-meta__item category"><a href="/blog/category/%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/">Разработка</a></span>
    <time class="post-meta__item date" itemprop="datePublished" datetime="2020-05-13T00:00:00+03:00">13 May 2020</time>
    
    <span class="post-meta__item reading-time" title="Estimated Read Time">
        

        <!--717-->

        
            ~2 min.
        
    </span>

    <meta itemprop="identifier" content="/blog/conquering-the-utm-parameters">
</div>

        <h1 class="post-title">
            <a href="/blog/conquering-the-utm-parameters/" itemprop="headline">Покорение UTM меток</a>
        </h1>
        <article itemprop="articleBody" class="js-emojify post__content">
            <p>Решил я тут собрать побольше статистики по посетителям.
Хотя Яндекс.Метрика очень даже неплохо с этим справляется,
но хотелось бы иметь более управляемый механизм,
в котором можно было разделить не только соц. сеть,
из которой пришел посетитель, но и какую из ссылок он нажал.</p>

<p>Или например, сколько человек посмотрело статью из секции “Latest Article” на главной странице,
сколько перелистнуло на следующий пост, и так далее. Выбор очевиден – нужно использовать UTM метки.
Они очень распространены в рекламной части бизнеса, но их можно использовать и для простой аналитики.
Но тут есть одна проблемка…</p>

<a id="cut"></a>
      <h2 id="постановка-задачи">
        
        
          Постановка задачи <a href="#%D0%BF%D0%BE%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%B7%D0%B0%D0%B4%D0%B0%D1%87%D0%B8" class="post__header-anchor" title="Anchor">#</a>
        
        
      </h2>

<p>Проблема в том, что эти метки <strong>очень</strong> массивные.
Вот к примеру, одна из возможных ссылок на пост в социальной сети выглядит следующим образом:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://vtvz.me/blog/social-post-generator/
    ?utm_source=_telegram
    &amp;utm_medium=social-post
    &amp;utm_campaign=blog
    &amp;utm_content=social-post-generator
</code></pre></div></div>

<p>Это 96 дополнительных символов!
Хотя многие соц. сети хорошо с этим справляются. Например, в VK такие ссылки ограничены одной строкой.
А в Twitter и LinkedIn есть свой укорачиватель. Но вот Телеграм так не умеет.</p>

<figure class="frame "><a href="./telegram.png" target="_blank"><img src="./telegram.png" alt="Жирная ссылка в Телеграмм" title="Жирная ссылка в Телеграмм"></a></figure>

<p>Тем не менее, помимо постов есть еще и ссылки на сайт в профилях соц. сетей.
В ВК, например, у меня целых 3 места, ведущих на главную страницу. 
И эти длиннющие ссылки немного пугают и уродливо выглядят.
Короче, задача в следующем: сделать эти ссылки простыми и эстетичными.</p>
    
      <h2 id="решения">
        
        
          Решения <a href="#%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D1%8F" class="post__header-anchor" title="Anchor">#</a>
        
        
      </h2>
    
      <h3 id="укорачиватель-ссылок">
        
        
          Укорачиватель ссылок <a href="#%D1%83%D0%BA%D0%BE%D1%80%D0%B0%D1%87%D0%B8%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C-%D1%81%D1%81%D1%8B%D0%BB%D0%BE%D0%BA" class="post__header-anchor" title="Anchor">#</a>
        
        
      </h3>

<p>Я уже давно пользуюсь сервисами, которые делают из монстров конфетку.
Вот например <a href="https://bitly.com/" target="_blank" rel="noopener noreferrer">Bitly</a> неплохо с этим справляется. 
Вот что он сделал со ссылкой, которую я указал ранее:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://bit.ly/vtvz-tg-post-generator
</code></pre></div></div>

<p>Уже гораздо лучше.</p>

<p>НО! Теперь эта ссылка не ведет на мой сайт. Она ведет на bit.ly, который уже кидает куда надо.
Проблема ли это? Для меня да. Мой сайт – моя визитная карточка, которая должна явно указывать, кому она принадлежит.
Так что, это отметается сразу.</p>
    
      <h3 id="свой-укорачиватель-ссылок">
        
        
          Свой укорачиватель ссылок <a href="#%D1%81%D0%B2%D0%BE%D0%B9-%D1%83%D0%BA%D0%BE%D1%80%D0%B0%D1%87%D0%B8%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C-%D1%81%D1%81%D1%8B%D0%BB%D0%BE%D0%BA" class="post__header-anchor" title="Anchor">#</a>
        
        
      </h3>

<p>А почему бы самому не укорачивать ссылки и публиковать уже их? Это решает проблему выше, но создает еще несколько.</p>

<ol>
  <li>Его нужно сделать. Это дополнительное время на реализацию целого компонента системы.
Сложность создает тот факт, что этот сайт статический, собран из обычных html страничек,
сгенерированных с помощью Jekyll, который написан на Ruby, который я не знаю… Ну вы поняли :grin:</li>
  <li>Обычные укорачиватели перекидывают тебя на другой сайт используя HTTP 301 код.
Но мы не можем отдавать этот статус клиенту, потому что статические сайты дают либо 200, либо 404.
А вот ВК не умеет обрабатывать такие страницы.</li>
  <li>Придется генерировать целую пачку укороченных сслылок для каждой записи в блоге.
Это значительно повышает ошибку человеческого фактора, значительно усложняет систему и захламляет проект.
<span class="text-muted">(Эта проблема справедлива и для предыдущего метода)</span>
</li>
  <li>Это сложно автоматизировать имеющимися инструментами.</li>
</ol>

<p>Вывод: тоже отбрасываем.</p>
    
      <h3 id="упаковка-меток">
        
        
          Упаковка меток <a href="#%D1%83%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BC%D0%B5%D1%82%D0%BE%D0%BA" class="post__header-anchor" title="Anchor">#</a>
        
        
      </h3>

<p>Я уверен, что этот метод использовался ранее, и что я изобрел велосипед.
Но результат, по-моему, получился просто невероятным. Принцип работы в следующем:</p>

<p>Вместе со ссылкой передается один единственный query параметр,
на основании его в url страницы применяются все необходимые utm метки.
Все это должно произойти <strong>ДО</strong> инициализации инструментов аналитики.</p>

<p>Выглядит это следующим образом:</p>

<ul>
  <li>Человек открывает ссылку <code class="language-plaintext highlighter-rouge">https://vtvz.me/blog/social-post-generator/?utm=tg</code>
</li>
  <li>Она распаковывается в
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>https://vtvz.me/blog/social-post-generator/
    ?utm_source=_telegram
    &amp;utm_medium=social-post
    &amp;utm_campaign=blog
    &amp;utm_content=social-post-generator
</code></pre></div>    </div>
  </li>
  <li>Запускаются Яндекс.Метрика и Google Analytics</li>
</ul>

<p>В итоге удалось упаковать 96 символов в 7! Вот как это работает…</p>
    
      <h2 id="реализация">
        
        
          Реализация <a href="#%D1%80%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F" class="post__header-anchor" title="Anchor">#</a>
        
        
      </h2>

<div class="alert alert-info">
    <p><b>Предупреждение!</b></p>
    <p>
        Весь дальнейший код написан на версии JavaScript, который поддерживается не всеми браузерами.
        Для совместимости со старыми версиями я использую webpack + babel.
        Но примеры достаточно просты, чтобы транспилировать их в классический JS.
    </p>
</div>

<p>Наш код должен работать следующим образом:</p>

<ol>
  <li>Вытянуть <code class="language-plaintext highlighter-rouge">utm</code> параметр из query адреса;</li>
  <li>Сгенерировать source, medium, campaign…</li>
  <li>Удалить параметр <code class="language-plaintext highlighter-rouge">utm</code>;</li>
  <li>Применить метки из пункта 2;</li>
  <li>Заменить текущий url на новый.</li>
</ol>

<p>Выглядит это так:</p>

<p>У нас есть карта стратегий обработки. Это объект, в ключах которого возможные utm сокращения,
а в значении – функция, которая генерирует все необходимые метки.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">strategies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">tg</span><span class="dl">'</span><span class="p">:</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="p">[</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">slug</span><span class="p">]</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">_</span> <span class="o">=&gt;</span> <span class="nx">_</span><span class="p">);</span>

        <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">source</span><span class="p">:</span> <span class="dl">'</span><span class="s1">_telegram</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">medium</span><span class="p">:</span> <span class="dl">'</span><span class="s1">social-post</span><span class="dl">'</span>
        <span class="p">}</span>

        <span class="nx">collection</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">campaign</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">);</span>
        <span class="nx">slug</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">slug</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p>В этом случае функция получает текущий адрес, на основании которого строит кампанию и контент.
Эта магия применима в моем случае. В вашем может быть что-то другое.</p>

<figure class="frame "><a href="./strategies.png" target="_blank"><img src="./strategies.png" alt="Карта стратегий" title="Карта стратегий"></a><figcaption><p>У меня карта стратегий выглядит вот так</p></figcaption></figure>

<p>Теперь нужна функция, которая сделает всю остальную работу:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @param {Window} w
 * @param {Document} d
 */</span>
<span class="kd">const</span> <span class="nx">utmResolver</span> <span class="o">=</span> <span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// В качестве параметров передаются window и document</span>
    <span class="c1">// 1. Парсим ссылку и вытягиваем utm параметр </span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
    <span class="kd">const</span> <span class="nx">utm</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">utm</span><span class="dl">'</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nx">utm</span> <span class="o">||</span> <span class="dl">''</span> <span class="o">===</span> <span class="nx">utm</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// В случае отсутствия стратегии просто ничего не делаем</span>
    <span class="kd">let</span> <span class="nx">strategy</span> <span class="o">=</span> <span class="nx">strategies</span><span class="p">[</span><span class="nx">utm</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">===</span> <span class="nx">strategy</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 2. Генерируем значения меток </span>
    <span class="kd">const</span> <span class="p">{</span>
        <span class="nx">source</span><span class="p">,</span>
        <span class="nx">medium</span><span class="p">,</span>
        <span class="nx">campaign</span><span class="p">,</span>
        <span class="nx">content</span><span class="p">,</span>
    <span class="p">}</span> <span class="o">=</span> <span class="nx">strategy</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    
    <span class="c1">// 3. Удаляем utm </span>
    <span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">'</span><span class="s1">utm</span><span class="dl">'</span><span class="p">);</span>
    <span class="c1">// 4. Применяем параметры </span>
    <span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">utm_source</span><span class="dl">'</span><span class="p">,</span> <span class="nx">source</span><span class="p">);</span>
    <span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">utm_medium</span><span class="dl">'</span><span class="p">,</span> <span class="nx">medium</span><span class="p">);</span>
    <span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">utm_campaign</span><span class="dl">'</span><span class="p">,</span> <span class="nx">campaign</span><span class="p">);</span>
    <span class="nx">content</span> <span class="o">&amp;&amp;</span> <span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">utm_content</span><span class="dl">'</span><span class="p">,</span> <span class="nx">content</span><span class="p">);</span>
    
    <span class="c1">// 5. Обновляем URL</span>
    <span class="nx">w</span><span class="p">.</span><span class="nx">history</span>
        <span class="p">?</span> <span class="nx">w</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">({},</span> <span class="nx">d</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">url</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
        <span class="p">:</span> <span class="nx">w</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Нам остается только вызвать эту функцию:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">utmResolver</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="nb">document</span><span class="p">);</span>
</code></pre></div></div>

<div class="alert alert-info">
    <p><b>Напоминание!</b></p>
    <p>
        Напомню, что это должно произойти ДО инициализации сборщиков статистики в синхронном потоке!
        Нарушение этих правил может привести и приведет к искажению результатов.
    </p>
</div>

<p>Благодаря этому ссылки стали куда лаконичнее, чем изначально.
Выбранный мною способ не является единственно верным.
Есть несколько альтернатив, как передать стратегию:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">vtvz.me/.../?u=tg</code></li>
  <li><code class="language-plaintext highlighter-rouge">vtvz.me/.../?_=tg</code></li>
  <li><code class="language-plaintext highlighter-rouge">vtvz.me/.../?=tg</code></li>
  <li><code class="language-plaintext highlighter-rouge">vtvz.me/.../?tg</code></li>
  <li><code class="language-plaintext highlighter-rouge">vtvz.me/.../#tg</code></li>
</ul>

<p>Ничто не мешает вам модифицировать приведенный выше скрипт под свои нужды.</p>

<p>Мне не удалось протестировать это дело в больших масштабах,
но текущие данные показывают правдивые результаты.
Так или иначе, если что-то пойдет не так – я сообщу.</p>

<p>А пока, спасибо за внимание :grin:
Если возникают вопросы, не стесняйтесь задавать их мне по любому доступному каналу,
пока комментарии не появились :fox:</p>
        </article>

        <hr>

        <div class="subscribe-post">
            <p>
                
                Мне будет очень приятно, если вы подпишитесь на обновления.
                
            </p>
            <div class="subscribe-post__items">
                <a class="subscribe-post__link subscribe-post__link--telegram" href="tg://resolve?domain=blog_vtvz"><i class="fa-fw fa-brands fa-telegram-plane"></i><span class="subscribe-post__label"> Telegram</span></a><a class="subscribe-post__link subscribe-post__link--vk" href="https://vk.com/blog_vtvz" target="_blank" rel="noopener noreferrer"><i class="fa-fw fa-brands fa-vk"></i><span class="subscribe-post__label"> VK</span></a><a class="subscribe-post__link subscribe-post__link--linkedin" href="https://www.linkedin.com/in/vtvz/" target="_blank" rel="noopener noreferrer"><i class="fa-fw fa-brands fa-linkedin-in"></i><span class="subscribe-post__label"> LinkedIn</span></a><a class="subscribe-post__link subscribe-post__link--github" href="https://github.com/vtvz/" target="_blank" rel="noopener noreferrer"><i class="fa-fw fa-brands fa-github-alt"></i><span class="subscribe-post__label"> GitHub</span></a><a class="subscribe-post__link subscribe-post__link--twitter" href="https://twitter.com/vtvz_me" target="_blank" rel="noopener noreferrer"><i class="fa-fw fa-brands fa-twitter"></i><span class="subscribe-post__label"> Twitter</span></a><a class="subscribe-post__link subscribe-post__link--rss" href="/feed.xml"><i class="fa-fw fa-solid fa-rss"></i><span class="subscribe-post__label"> RSS</span></a>
            </div>
        </div>

        <div class="post-tags">
            
            <a href="/blog/tag/%D0%B2%D0%B5%D0%B1-%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/" itemprop="about">Веб-разработка</a>,
            
            <a href="/blog/tag/%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D1%82%D0%B8%D0%BA%D0%B0/" itemprop="about">Аналитика</a>,
            
            <a href="/blog/tag/frontend/" itemprop="about">Frontend</a>
            
        </div>
    </div>
    <div class="box">
        <div class="row">
            <div class="col-xs-12 col-sm-6 text-left">
                
                <div>« Previous</div>
                <a class="prev" href="/blog/social-post-generator/?utm=_prev">Генератор постов в социальные сети</a>
                
            </div>

            
            <div class="col-xs-12 col-sm-6 text-right">
                <div>Next »</div>
                <a class="next" href="/blog/reliable-emojification/?utm=_next">Аккуратно внедряем Emoji, не ломая все остальное</a>
            </div>
            
        </div>
    </div>
    <div class="box comments" id="comments">
    <script async src="https://telegram.org/js/telegram-widget.js?19" data-telegram-discussion="channel_for_old_posts_comments" data-comments-limit="5" data-color="1380EC" data-dark="1"></script>
</div>

</div>

        </div>

        <aside class="col-md-4 col-sm-12 sidebar">
            
            
            
            
            <div class="sidebox box hidden-sm hidden-xs">
                <h3 class="section-title">In this Article:</h3>
                <ul class="circled">
  <li><a href="#%D0%BF%D0%BE%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%B7%D0%B0%D0%B4%D0%B0%D1%87%D0%B8">Постановка задачи</a></li>
  <li>
<a href="#%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D1%8F">Решения</a>
    <ul>
      <li><a href="#%D1%83%D0%BA%D0%BE%D1%80%D0%B0%D1%87%D0%B8%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C-%D1%81%D1%81%D1%8B%D0%BB%D0%BE%D0%BA">Укорачиватель ссылок</a></li>
      <li><a href="#%D1%81%D0%B2%D0%BE%D0%B9-%D1%83%D0%BA%D0%BE%D1%80%D0%B0%D1%87%D0%B8%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C-%D1%81%D1%81%D1%8B%D0%BB%D0%BE%D0%BA">Свой укорачиватель ссылок</a></li>
      <li><a href="#%D1%83%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BC%D0%B5%D1%82%D0%BE%D0%BA">Упаковка меток</a></li>
    </ul>
  </li>
  <li><a href="#%D1%80%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F">Реализация</a></li>
</ul>
            </div>
            
            

            <div class="sidebox box">
                <h3 class="section-title">Categories</h3>
                <ul class="circled">
                    
                    
                    
                    
                    
                    <li data-sort="0011">
                        <a href="/blog/category/%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/">
                            Разработка <span class="badge">10</span>
                        </a>
                    </li>
                    
                    <li data-sort="0018">
                        <a href="/blog/category/livelog/">
                            LiveLog <span class="badge">3</span>
                        </a>
                    </li>
                    
                    <li data-sort="0019">
                        <a href="/blog/category/devops/">
                            DevOps <span class="badge">2</span>
                        </a>
                    </li>
                    
                    <li data-sort="0019">
                        <a href="/blog/category/%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B/">
                            Сервисы <span class="badge">2</span>
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a href="/blog/category/android/">
                            Android <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a href="/blog/category/linux/">
                            Linux <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a href="/blog/category/%D0%B8%D0%BF/">
                            ИП <span class="badge">1</span>
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a href="/blog/category/%D0%BE%D0%BF%D1%8B%D1%82/">
                            Опыт <span class="badge">1</span>
                        </a>
                    
                </li>
</ul>
            </div>

            <div class="sidebox box">
                <h3 class="section-title">Tags</h3>
                <ul class="tag-list">
                    
                    
                    
                    
                    
                    <li data-sort="0010">
                        <a class="btn" href="/blog/tag/%D0%B2%D0%B5%D0%B1-%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/">
                            Веб-разработка [11]
                        </a>
                    </li>
                    
                    <li data-sort="0015">
                        <a class="btn" href="/blog/tag/%D0%B1%D0%BB%D0%BE%D0%B3/">
                            Блог [6]
                        </a>
                    </li>
                    
                    <li data-sort="0018">
                        <a class="btn" href="/blog/tag/jekyll/">
                            Jekyll [3]
                        </a>
                    </li>
                    
                    <li data-sort="0018">
                        <a class="btn" href="/blog/tag/%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F/">
                            Обновления [3]
                        </a>
                    </li>
                    
                    <li data-sort="0019">
                        <a class="btn" href="/blog/tag/docker/">
                            Docker [2]
                        </a>
                    </li>
                    
                    <li data-sort="0019">
                        <a class="btn" href="/blog/tag/frontend/">
                            Frontend [2]
                        </a>
                    </li>
                    
                    <li data-sort="0019">
                        <a class="btn" href="/blog/tag/kubernetes/">
                            Kubernetes [2]
                        </a>
                    </li>
                    
                    <li data-sort="0019">
                        <a class="btn" href="/blog/tag/%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B/">
                            Инструменты [2]
                        </a>
                    </li>
                    
                    <li data-sort="0019">
                        <a class="btn" href="/blog/tag/%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B/">
                            Сервисы [2]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/android/">
                            Android [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/code-style/">
                            Code-style [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/ecryptfs/">
                            eCryptfs [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/emoji/">
                            Emoji [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/helm/">
                            Helm [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/linux/">
                            Linux [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/nginx/">
                            Nginx [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/petproject/">
                            PetProject [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/php/">
                            PHP [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/rip/">
                            RIP [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/rustify/">
                            Rustify [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/telegram/">
                            Telegram [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/telegrambot/">
                            TelegramBot [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D1%82%D0%B8%D0%BA%D0%B0/">
                            Аналитика [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%B1%D0%B0%D0%B7%D1%8B-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/">
                            Базы данных [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D1%8C/">
                            Безопасность [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%B1%D0%B8%D0%B7%D0%BD%D0%B5%D1%81/">
                            Бизнес [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%B5%D0%B4%D0%B0/">
                            Еда [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%B6%D0%B8%D0%B2%D0%BE%D1%82%D0%BD%D1%8B%D0%B5/">
                            Животные [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%B8%D0%BF/">
                            ИП [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%BC%D0%B0%D0%B3%D0%B0%D0%B7%D0%B8%D0%BD%D1%8B/">
                            Магазины [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%BC%D1%83%D0%B7%D1%8B%D0%BA%D0%B0/">
                            Музыка [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%BD%D0%B0%D0%BB%D0%BE%D0%B3%D0%B8/">
                            Налоги [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F/">
                            Оптимизация [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D1%8B/">
                            Программы [1]
                        </a>
                    </li>
                    
                    <li data-sort="0020">
                        <a class="btn" href="/blog/tag/%D1%83%D1%81%D0%BD/">
                            УСН [1]
                        </a>
                    
                </li>
</ul>
                <div class="tag-list__more-wrapper">
                    <button class="btn btn-block tag-list__more">Show 29 more...</button>
                </div>
            </div>
        </aside>
    </div>
    <div class="clearfix"></div>
    <div class="row">
        <div class="col-md-8 col-sm-12">
            <footer class="box text-center">
    © 2024 Vitaly Zaslavsky. All rights reserved.
</footer>

        </div>
    </div>
</div>


</div>

<div class="subscription-block" id="subscribe">
    <a href="#" class="subscription-block__close"></a>
    <div class="subscription-block__list">
        <div class="subscription-block__list-title">
            Подписаться
        </div>
        <div class="subscription-block__list-item">
            <a class="subscription-block__link subscription-block__link--telegram" href="tg://resolve?domain=blog_vtvz">
                <i class="fa-fw fa-brands fa-telegram-plane subscription-block__icon"></i><span class="subscription-block__label"> Telegram</span>
            </a>
        </div>
<div class="subscription-block__list-item">
            <a class="subscription-block__link subscription-block__link--vk" href="https://vk.com/blog_vtvz" target="_blank" rel="noopener noreferrer">
                <i class="fa-fw fa-brands fa-vk subscription-block__icon"></i><span class="subscription-block__label"> VK</span>
            </a>
        </div>
<div class="subscription-block__list-item">
            <a class="subscription-block__link subscription-block__link--linkedin" href="https://www.linkedin.com/in/vtvz/" target="_blank" rel="noopener noreferrer">
                <i class="fa-fw fa-brands fa-linkedin-in subscription-block__icon"></i><span class="subscription-block__label"> LinkedIn</span>
            </a>
        </div>
<div class="subscription-block__list-item">
            <a class="subscription-block__link subscription-block__link--github" href="https://github.com/vtvz/" target="_blank" rel="noopener noreferrer">
                <i class="fa-fw fa-brands fa-github-alt subscription-block__icon"></i><span class="subscription-block__label"> GitHub</span>
            </a>
        </div>
<div class="subscription-block__list-item">
            <a class="subscription-block__link subscription-block__link--twitter" href="https://twitter.com/vtvz_me" target="_blank" rel="noopener noreferrer">
                <i class="fa-fw fa-brands fa-twitter subscription-block__icon"></i><span class="subscription-block__label"> Twitter</span>
            </a>
        </div>
<div class="subscription-block__list-item">
            <a class="subscription-block__link subscription-block__link--rss" href="/feed.xml">
                <i class="fa-fw fa-solid fa-rss subscription-block__icon"></i><span class="subscription-block__label"> RSS</span>
            </a>
        </div>
    </div>
</div>


        
        <script src="https://browser.sentry-cdn.com/6.19.7/bundle.min.js" integrity="sha384-KXjn4K+AYjp1cparCXazrB+5HKdi69IUYz8glD3ySH3fnDgMX3Wg6VTMvXUGr4KB" crossorigin="anonymous"></script>
        <script>Sentry.init({ dsn: 'https://9969aeb380dc4927b6ed1e20f6fa772c@o396821.ingest.sentry.io/5250691' });</script>
        

        <script src="/assets/js/jquery.min.js?cb=0571615"></script>
        <script src="/assets/js/bootstrap.min.js?cb=1dad3b3"></script>
        <script src="/assets/js/plugins.js?cb=932ef83"></script>
        <script src="/assets/js/scripts.js?cb=78bb624"></script>
        <script src="/assets/javascript/bundle.eefa.js"></script>

        <script>
            

            main.resolveUtm(window, document);
        </script>

        
        <!-- Yandex.Metrika counter -->
        <script type="text/javascript"> (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)}; m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)}) (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym"); ym(+"31771726", "init", { clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true }); </script> <noscript><div><img src="https://mc.yandex.ru/watch/31771726" style="position:absolute; left:-9999px;" alt=""></div></noscript>
        <!-- /Yandex.Metrika counter -->

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-131047185-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-131047185-1');
        </script>
        
    </body>
</html>
