<!doctype html>
<html lang="en">
    <!--Built at : 2019-11-06 19:34:16-->
    <head>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Пишем свой Doctrine Annotation Fixer для PHP-CS-Fixer</title>

        <link rel="stylesheet" href="/assets/css/bootstrap.css">
        <link rel="stylesheet" href="/assets/css/main.css">
        <link rel="stylesheet" href="/assets/css/type/budicons.css">
        <link rel="stylesheet" href="/assets/css/type/fontello.css">
        <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,800&subset=latin,cyrillic" rel="stylesheet" crossorigin="anonymous">

        <link rel="alternate" type="application/rss+xml" title="Виталий Заславский – web-разработчик, который любит свое дело" href="https://vtvz.ru/feed.xml">

        <meta name="theme-color" content="#232323">

        <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Пишем свой Doctrine Annotation Fixer для PHP-CS-Fixer" />
<meta name="author" content="Виталий Заславский" />
<meta property="og:locale" content="ru_RU" />
<meta name="description" content="Как написать свой фиксер для PHP-CS-Fixer, который будет исправлять Doctrine аннотации, расставляя и убирая запятые там, где нужно." />
<meta property="og:description" content="Как написать свой фиксер для PHP-CS-Fixer, который будет исправлять Doctrine аннотации, расставляя и убирая запятые там, где нужно." />
<link rel="canonical" href="https://vtvz.ru/blog/custom-doctrine-annotation-fixer/" />
<meta property="og:url" content="https://vtvz.ru/blog/custom-doctrine-annotation-fixer/" />
<meta property="og:site_name" content="Виталий Заславский – web-разработчик, который любит свое дело" />
<meta property="og:image" content="https://vtvz.ru/assets/images/logo-black.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-11-06T00:00:00+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://vtvz.ru/assets/images/logo-black.png" />
<meta property="twitter:title" content="Пишем свой Doctrine Annotation Fixer для PHP-CS-Fixer" />
<meta name="twitter:site" content="@vtvz_ru" />
<meta name="twitter:creator" content="@vtvz_ru" />
<meta name="google-site-verification" content="08mKX1M9WC3jlftJg-ZY3MsQEQTRV0w5fQaynQLwMXI" />
<meta name="yandex-verification" content="66bb5c18895519c2" />
<script type="application/ld+json">
{"headline":"Пишем свой Doctrine Annotation Fixer для PHP-CS-Fixer","dateModified":"2019-11-06T00:00:00+03:00","datePublished":"2019-11-06T00:00:00+03:00","description":"Как написать свой фиксер для PHP-CS-Fixer, который будет исправлять Doctrine аннотации, расставляя и убирая запятые там, где нужно.","author":{"@type":"Person","name":"Виталий Заславский"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://vtvz.ru/assets/images/logo-black.png"},"name":"Виталий Заславский"},"image":"https://vtvz.ru/assets/images/logo-black.png","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://vtvz.ru/blog/custom-doctrine-annotation-fixer/"},"url":"https://vtvz.ru/blog/custom-doctrine-annotation-fixer/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    </head>

    <body class="full-layout">
        <div id="preloader"><div id="status"><div class="spinner"></div></div></div>

<div id="bg"></div>

<div class="body-wrapper">
      <nav class="navbar navbar-default" role="navigation">
    <div class="navbar-header">
      <a class="btn responsive-menu" data-toggle="collapse" data-target=".navbar-collapse"><i></i></a>
      <div class="navbar-brand text-center">
        <a href="/">
          <img src="/assets/images/logo.svg" alt="Logo" class="logo">
        </a>
      </div>
      <!-- /.navbar-brand -->
    </div>
    <!-- /.navbar-header -->
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <!-- <li class="current"> -->
        <li>
            <a href="/" class="hint--right" data-hint="Главная"><i class="budicon-home-1"></i><span>Главная</span></a>
        </li>
        <li class="current">
            <a href="/blog/" class="hint--right" data-hint="Блог"><i class="budicon-book-1"></i><span>Блог</span></a>
        </li>
      </ul>
      <!-- /.navbar-nav -->
    </div>
    <!-- /.navbar-collapse -->
  </nav>
  <!-- /.navbar -->

    <div class="container inner">
    <div class="blog list-view row">
        <div class="col-md-8 col-sm-12 content">
            <div class="blog-posts">
    <div class="post box">
        <div class="meta">
    <span class="category"><a href="/blog/category/%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/">Разработка</a></span>
    <span class="date">06 ноя 2019</span>
    <span class="comments" title="Комментарии"><a href="#commento"></a></span>
    <span class="reading-time" title="Примерное время чтения">
        

        <!--1731-->

        
            ~9 мин.
        
    </span>
</div>

        <h1 class="post-title">
            <a href="/blog/custom-doctrine-annotation-fixer/">Пишем свой Doctrine Annotation Fixer для PHP-CS-Fixer</a>
        </h1>
        <div>
            <p>В плане код-стайла я немного маньяк.
Я убежден – чем более строгие правила, тем качественнее будет кодовая база.
Когда я только пришел в компанию <a href="https://axmit.com/" target="_blank" rel="noopener noreferrer">Axmit</a> в качестве разработчика,
моей личной целью стало создание перечня правил, а также настройка всякого рода фиксеров и снифферов.
Теперь у нас используется как <a href="https://github.com/squizlabs/PHP_CodeSniffer" target="_blank" rel="noopener noreferrer">CodeSniffer</a>, так и <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer" target="_blank" rel="noopener noreferrer">PHP-CS-Fixer</a>.</p>

<p>Большинство правил у нас автоматизированы <a href="https://www.jetbrains.com/phpstorm/" target="_blank" rel="noopener noreferrer">PHPStorm</a> и <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer" target="_blank" rel="noopener noreferrer">PHP-CS-Fixer</a>,
поэтому следование им не создает слишком много боли.</p>

<p>Но был момент, который не был ни в одном из этих инструментов, заставляюший меня страдать.</p>

<a id="cut"></a>

<p>Все дело в Doctrine аннотациях. Шторм с ними ничего не делает совсем.
А вот фиксер имеет ряд правил, исправляющих отступы, скобочки и т.п.</p>

<p>А вот в чем была проблема. Обратите внимание на запятые.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sd">/**
 * @SWG\Definition(
 *     definition="ActionFilterRequest",
 *     @SWG\Property(property="service_id", type="integer")
 * )
 */</span>
</code></pre></div></div>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sd">/**
 * @SWG\Definition(
 *     definition="ActionFilterRequest",
 *     @SWG\Property(property="service_id", type="integer",),
 * )
 */</span>
</code></pre></div></div>

<p>Эти оба куска абсолютно идентичны с точки зрения Доктрины.
И нет ни одного фиксера (по крайней мере я не нашел), который расставит все запятые по своим местам.
Вручную следить за этим достаточно сложно. Поэтому решено было написать своё правило.</p>

<p>Я хочу, чтобы на выходе после исправления это было так:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sd">/**
 * @SWG\Definition(
 *     definition="ActionFilterRequest",
 *     @SWG\Property(property="service_id", type="integer"),
 * )
 */</span>
</code></pre></div></div>

<p>То есть точно также, как с массивами:
при однострочной записи без запятой в конце последнего элемента,
а при многострочной – с.</p>

<p>И так, приступим!</p>

<h2 id="исследование">Исследование</h2>

<p>Внутри библиотеки все фиксеры для доктриновских аннотаций унаследованы от класса <code class="highlighter-rouge">\PhpCsFixer\AbstractDoctrineAnnotationFixer</code>
с одним единственным абстрактным методом <code class="highlighter-rouge">fixAnnotations</code>.</p>

<p>Исследовав другие фиксеры ближе, можно увидеть, что в этот метод передается только один параметр – коллекция токенов.
Эта коллекция мутабельная и результат её изменений будет использоваться для формирования итогового кода.</p>

<p>Минимально возможный фиксер, который пока ничего не делает, выглядит примерно так:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//  Тут есть пара неиспользуемых импортов, но скоро они будут нужны</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\Annotations\DocLexer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PhpCsFixer\AbstractDoctrineAnnotationFixer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PhpCsFixer\Doctrine\Annotation\Token</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PhpCsFixer\Doctrine\Annotation\Tokens</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PhpCsFixer\FixerDefinition\FixerDefinition</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PhpCsFixer\FixerDefinition\FixerDefinitionInterface</span><span class="p">;</span>

<span class="k">final</span> <span class="k">class</span> <span class="nc">DoctrineAnnotationCommasFixer</span> <span class="k">extends</span> <span class="nx">AbstractDoctrineAnnotationFixer</span>
<span class="p">{</span>
    <span class="sd">/**
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="na">name</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">name</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">'Axmit/doctrine_annotation_commas'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @return FixerDefinitionInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getDefinition</span><span class="p">()</span><span class="o">:</span> <span class="nx">FixerDefinitionInterface</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">FixerDefinition</span><span class="p">(</span><span class="s1">'Fixes commas in Doctrine annotations'</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Fixes Doctrine annotations from the given PHPDoc style comment.
     *
     * @param Tokens $tokens
     *
     * @return void
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">fixAnnotations</span><span class="p">(</span><span class="nx">Tokens</span> <span class="nv">$tokens</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Обратите особое внимание на методы <code class="highlighter-rouge">name</code> и <code class="highlighter-rouge">getName</code>.
Имя фиксера должно быть строго в таком формате, иначе будет ошибка
(регулярки можно посмотреть в <code class="highlighter-rouge">\PhpCsFixer\FixerNameValidator::isValid</code>).
Статическим методом <code class="highlighter-rouge">name</code> воспользуемся чуть позже.</p>

<p>Дабы не нагромождать статью простынями кода, все остальные куски исходников будут внутри метода <code class="highlighter-rouge">fixAnnotations</code>.</p>

<h2 id="регистрация">Регистрация</h2>

<p>Чтобы понять, как заставить фиксер включить моё правило потребовался почти час.
Для того, чтобы все заработало, нужно сделать 2 вещи:</p>

<ol>
  <li>Зарегистрировать фиксер в конфиге (файл <code class="highlighter-rouge">.php_cs.dist</code>):
    <div class="language-php highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">registerCustomFixers</span><span class="p">([</span><span class="k">new</span> <span class="nx">DoctrineAnnotationCommasFixer</span><span class="p">()])</span>
</code></pre></div>    </div>
    <p>Теперь фиксер знает о существовании этого правила, но пока не использует его.</p>
  </li>
  <li>Включить его в рулзах:
    <div class="language-php highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">setRules</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="nx">DoctrineAnnotationCommasFixer</span><span class="o">::</span><span class="na">name</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// помните статический метод name? :-)</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>И только тогда фиксер не только подключит это правило, но и будет его использовать.</p>

<h2 id="исправление">Исправление</h2>

<p>Настало время написать логику и оживить наш фикс!</p>

<p>Если описать словами, то суть такова:</p>

<ol>
  <li>Найти все закрывающие обычные и фигурные скобки;</li>
  <li>Посмотреть, что перед ними:
    <ol>
      <li>Если это пустота (игнорируемый код), то добавить перед ней запятую, если запятой нет;</li>
      <li>Если это запятая – удалить</li>
    </ol>
  </li>
</ol>

<p>По коллекции токенов можно пройтись циклом, как по массиву.
Но мы этого делать не будем по причине, которую я объясню позже.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$tokens</span><span class="o">-&gt;</span><span class="na">offsetExists</span><span class="p">(</span><span class="nv">$index</span><span class="p">))</span> <span class="p">{</span>
    <span class="sd">/** @var Token $token */</span>
    <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$tokens</span><span class="o">-&gt;</span><span class="na">offsetGet</span><span class="p">(</span><span class="nv">$index</span><span class="p">);</span>

    <span class="c1">//TODO Add logic here </span>

    <span class="nv">$index</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Класс <code class="highlighter-rouge">Token</code> имеет 2 важных свойства – это тип и содержимое.
Тип является числовым значением, все из которых находятся в классе <code class="highlighter-rouge">DocLexer</code> в виде констант.</p>

<p>Проверить тип токена можно методом <code class="highlighter-rouge">isType</code>, куда можно передать либо одно значение, либо массив:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$token</span><span class="o">-&gt;</span><span class="na">isType</span><span class="p">([</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_CLOSE_CURLY_BRACES</span><span class="p">,</span> <span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_CLOSE_PARENTHESIS</span><span class="p">]);</span>
</code></pre></div></div>

<p>С первым пунктом разобрались – мы нашли все закрывающие скобки.
Далее нужно вытянуть 2 токена перед текущим:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$prevToken</span>     <span class="o">=</span> <span class="nv">$tokens</span><span class="o">-&gt;</span><span class="na">offsetGet</span><span class="p">(</span><span class="nv">$index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="nv">$prevPrevToken</span> <span class="o">=</span> <span class="nv">$tokens</span><span class="o">-&gt;</span><span class="na">offsetGet</span><span class="p">(</span><span class="nv">$index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
</code></pre></div></div>

<p>Далее просто: если предыдущий токен – ничего 
(это могут быть пробелы, переносы строк и знак * в любом порядке и количестве;
стоит отметить, что в коллекции 2 токена “ничего” подряд не бывает),
и токен перед ним не является запятой, то нужно добавить запятую:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nv">$prevToken</span><span class="o">-&gt;</span><span class="na">isType</span><span class="p">(</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$prevPrevToken</span><span class="o">-&gt;</span><span class="na">isType</span><span class="p">(</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_COMMA</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$tokens</span><span class="o">-&gt;</span><span class="na">insertAt</span><span class="p">(</span><span class="nv">$index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Token</span><span class="p">(</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_COMMA</span><span class="p">,</span> <span class="s1">','</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Иначе, если сразу перед скобкой стоит запятая – убрать:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">elseif</span> <span class="p">(</span><span class="nv">$prevToken</span><span class="o">-&gt;</span><span class="na">isType</span><span class="p">(</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_COMMA</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$prevToken</span><span class="o">-&gt;</span><span class="na">clear</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>И вроде бы уже все, но если попробовать запустить фиксер с этим правилом, он никогда не завершит свою работу.
Проблема кроется там, где мы добавляем запятую – программа уходит в бесконечный цикл.
Чтобы решить эту проблему, достаточно добавить еще один <code class="highlighter-rouge">$index++</code> после добавления запятой:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nv">$prevToken</span><span class="o">-&gt;</span><span class="na">isType</span><span class="p">(</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$prevPrevToken</span><span class="o">-&gt;</span><span class="na">isType</span><span class="p">(</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_COMMA</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$tokens</span><span class="o">-&gt;</span><span class="na">insertAt</span><span class="p">(</span><span class="nv">$index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Token</span><span class="p">(</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_COMMA</span><span class="p">,</span> <span class="s1">','</span><span class="p">));</span>
    <span class="nv">$index</span><span class="o">++</span><span class="p">;</span> <span class="c1">// причина, по которой нужен был цикл while вместо for</span>
<span class="p">}</span>
</code></pre></div></div>

<p>И все! Фиксер готов, можно выдохнуть <img class="emoji" title=":grin:" alt=":grin:" src="/assets/images/emoji/unicode/1f601.png" height="20" width="20"></p>

<details class="spoiler"><summary class="spoiler-title">Собрав все воедино</summary><div class="spoiler-body">
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Doctrine\Common\Annotations\DocLexer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PhpCsFixer\AbstractDoctrineAnnotationFixer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PhpCsFixer\Doctrine\Annotation\Token</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PhpCsFixer\Doctrine\Annotation\Tokens</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PhpCsFixer\FixerDefinition\FixerDefinition</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PhpCsFixer\FixerDefinition\FixerDefinitionInterface</span><span class="p">;</span>

<span class="k">final</span> <span class="k">class</span> <span class="nc">DoctrineAnnotationCommasFixer</span> <span class="k">extends</span> <span class="nx">AbstractDoctrineAnnotationFixer</span>
<span class="p">{</span>
    <span class="sd">/**
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="na">name</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">name</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">'Axmit/doctrine_annotation_commas'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @return FixerDefinitionInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getDefinition</span><span class="p">()</span><span class="o">:</span> <span class="nx">FixerDefinitionInterface</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">FixerDefinition</span><span class="p">(</span><span class="s1">'Fixes commas in Doctrine annotations'</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Fixes Doctrine annotations from the given PHPDoc style comment.
     *
     * @param Tokens $tokens
     *
     * @return void
     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">fixAnnotations</span><span class="p">(</span><span class="nx">Tokens</span> <span class="nv">$tokens</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="nv">$index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$tokens</span><span class="o">-&gt;</span><span class="na">offsetExists</span><span class="p">(</span><span class="nv">$index</span><span class="p">))</span> <span class="p">{</span>
            <span class="sd">/** @var Token $token */</span>
            <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$tokens</span><span class="o">-&gt;</span><span class="na">offsetGet</span><span class="p">(</span><span class="nv">$index</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$token</span><span class="o">-&gt;</span><span class="na">isType</span><span class="p">([</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_CLOSE_CURLY_BRACES</span><span class="p">,</span> <span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_CLOSE_PARENTHESIS</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$prevToken</span>     <span class="o">=</span> <span class="nv">$tokens</span><span class="o">-&gt;</span><span class="na">offsetGet</span><span class="p">(</span><span class="nv">$index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                <span class="nv">$prevPrevToken</span> <span class="o">=</span> <span class="nv">$tokens</span><span class="o">-&gt;</span><span class="na">offsetGet</span><span class="p">(</span><span class="nv">$index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$prevToken</span><span class="o">-&gt;</span><span class="na">isType</span><span class="p">(</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$prevPrevToken</span><span class="o">-&gt;</span><span class="na">isType</span><span class="p">(</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_COMMA</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nv">$tokens</span><span class="o">-&gt;</span><span class="na">insertAt</span><span class="p">(</span><span class="nv">$index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Token</span><span class="p">(</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_COMMA</span><span class="p">,</span> <span class="s1">','</span><span class="p">));</span>
                    <span class="nv">$index</span><span class="o">++</span><span class="p">;</span> <span class="c1">// prevent infinite loop</span>
                <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$prevToken</span><span class="o">-&gt;</span><span class="na">isType</span><span class="p">(</span><span class="nx">DocLexer</span><span class="o">::</span><span class="na">T_COMMA</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nv">$prevToken</span><span class="o">-&gt;</span><span class="na">clear</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nv">$index</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>
</div></details>

<h2 id="послесловие">Послесловие</h2>

<p>Тут стоит отметить пару моментов:</p>

<ol>
  <li>Если вы, как и я, пользуетесь PHPStorm, то вы могли увидеть, что классы <code class="highlighter-rouge">AbstractDoctrineAnnotationFixer</code>, <code class="highlighter-rouge">Token</code> и <code class="highlighter-rouge">Tokens</code> зачеркнуты.
А происходит это по простой причине – они помечены как внутренние тегом <code class="highlighter-rouge">@internal</code>.
Для нас это означает то, что наш фикс может сломаться в любой момент даже между минорными версиями,
так как никто не обещает стабильного API во внутреннем коде.
(на момент написания статьи использовался <code class="highlighter-rouge">friendsofphp/php-cs-fixer:v2.15.1</code>)
Так что… все на свой страх и риск.</li>
  <li>Тесты… Я уверен, что для этого можно и нужно писать тесты, в том числе и для проверки совместимости с новой версией фиксера,
но делать я этого не стал.
Просто потому что не нашел это необходимым в данный момент.
Возможно, я с этим разберусь и дополню текущую или напишу новую статью.</li>
  <li>Потенциально написанное мной правило может работать не так в каких-то крайних случаях.
Но я прогнал его по двум нашим проектам, где более <strong><nobr>2500 (!)</nobr></strong> вложенных друг в друга аннотаций,
и он расставил запятые во все места и не испортил ни единого файла.
Поэтому я считаю этот вариант вполне себе рабочим и проверенным.</li>
</ol>

<p>Спасибо за прочтение! <img class="emoji" title=":blush:" alt=":blush:" src="/assets/images/emoji/unicode/1f60a.png" height="20" width="20"></p>

<hr>

<p>P.S. Внизу, после поста, появился блок с комментариями.
Не стесняйтесь задавать вопросы и указывать на ошибки и неточности.
Я всегда рад коммуникации <img class="emoji" title=":wink:" alt=":wink:" src="/assets/images/emoji/unicode/1f609.png" height="20" width="20"></p>


        </div>
        <div class="meta tags">
            
            <a href="/blog/tag/%D0%B2%D0%B5%D0%B1-%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/">Веб-разработка</a>,
            
            <a href="/blog/tag/php/">PHP</a>,
            
            <a href="/blog/tag/code-style/">Code-style</a>
            
        </div>
    </div>
    <div class="box">
        <div class="row">
            
            <div class="col-xs-12 col-sm-6 text-left">
                <div>« Предыдущая</div>
                <a class="prev" href="/blog/right-way-to-store-passwords/">Как правильно хранить пароли</a>
            </div>
            

            
        </div>
    </div>
    
    <div class="divide20"></div>
    <div class="box commento">
        <div id="commento"></div>
        <script data-css-override="/assets/css/commento.css" data-no-fonts="true" src="https://cdn.commento.io/js/commento.js"></script>
    </div>
</div>

        </div>

        <aside class="col-md-4 col-sm-12 sidebar">
                    
                    <div class="sidebox box widget hidden-sm hidden-xs">
                        <h3 class="widget-title section-title">В этой статье:</h3>
                        <ul class="circled">
  <li><a href="#%D0%B8%D1%81%D1%81%D0%BB%D0%B5%D0%B4%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">Исследование</a></li>
  <li><a href="#%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%86%D0%B8%D1%8F">Регистрация</a></li>
  <li><a href="#%D0%B8%D1%81%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5">Исправление</a></li>
  <li><a href="#%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D1%81%D0%BB%D0%BE%D0%B2%D0%B8%D0%B5">Послесловие</a></li>
</ul>

                    </div>
                    

                    <div class="sidebox box widget">
                        <h3 class="widget-title section-title">Категории</h3>
                        <ul class="circled">
                            
                            <li><a href="/blog/category/%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/">Разработка
                                [4]</a></li>
                            
                            <li><a href="/blog/category/%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B/">Сервисы
                                [2]</a></li>
                            
                        </ul>
                    </div>

                    <div class="sidebox box widget">
                        <h3 class="widget-title section-title">Теги</h3>
                        <ul class="tag-list">
                            
                            <li><a href="/blog/tag/%D0%B1%D0%BB%D0%BE%D0%B3/" class="btn">Блог
                                [1]</a></li>
                            
                            <li><a href="/blog/tag/%D0%B2%D0%B5%D0%B1-%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0/" class="btn">Веб-разработка
                                [4]</a></li>
                            
                            <li><a href="/blog/tag/%D0%B1%D0%B0%D0%B7%D1%8B-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/" class="btn">Базы данных
                                [1]</a></li>
                            
                            <li><a href="/blog/tag/jekyll/" class="btn">Jekyll
                                [1]</a></li>
                            
                            <li><a href="/blog/tag/%D0%BC%D1%83%D0%B7%D1%8B%D0%BA%D0%B0/" class="btn">Музыка
                                [1]</a></li>
                            
                            <li><a href="/blog/tag/%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B/" class="btn">Сервисы
                                [2]</a></li>
                            
                            <li><a href="/blog/tag/%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D1%8B/" class="btn">Программы
                                [1]</a></li>
                            
                            <li><a href="/blog/tag/%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D1%8C/" class="btn">Безопасность
                                [1]</a></li>
                            
                            <li><a href="/blog/tag/php/" class="btn">PHP
                                [1]</a></li>
                            
                            <li><a href="/blog/tag/code-style/" class="btn">Code-style
                                [1]</a></li>
                            
                        </ul>
                    </div>

                    
        </aside>
    </div>
</div>
<script src="https://cdn.commento.io/js/count.js"></script>

</div>

<script src="/assets/js/jquery.min.js"></script> 
<script src="/assets/js/bootstrap.min.js"></script> 
<script src="/assets/js/jquery.themepunch.tools.min.js"></script> 
<script src="/assets/js/classie.js"></script> 
<script src="/assets/js/plugins.js"></script> 
<script src="/assets/js/scripts.js"></script>  

        <script type="text/javascript" src="/assets/javascripts/bundle.js" charset="utf-8"></script>

        
        <!-- Yandex.Metrika counter -->
        <script type="text/javascript"> (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)}; m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)}) (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym"); ym(31771726, "init", { id:31771726, clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true }); </script> <noscript><div><img src="https://mc.yandex.ru/watch/31771726" style="position:absolute; left:-9999px;" alt=""></div></noscript>
        <!-- /Yandex.Metrika counter -->

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-131047185-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-131047185-1');
        </script>

        
    </body>
</html>
